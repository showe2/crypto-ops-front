import React,{useState}from'react';import{api,download}from'@lib/api';import{openChart}from'@lib/charts';import{Badge,Button,Card,CopyBtn,Input}from'@components/UI';
export default function PoiskPanel(){const[q,setQ]=useState('');const[r,setR]=useState<any|null>(null);const[chat,setChat]=useState<any[]>([]);const[ask,setAsk]=useState('');const run=async()=>{try{const x=await api('GET',`/api/token/report?query=${encodeURIComponent(q)}`);setR(x);}catch{setR({name:'DEMO-COIN',contract:'DeMo...',liq:42000,mcap:180000,risk:'LOW',links:{},social:{x:'+230%',tg:'30/ч'},security:{goplus:'OK',rug:'OK',sniffer:'OK'},lastPump:'2025-09-04 18:45',nextWindow:'20–40м',verdict:'BUY / WATCH',mint:'MintZ999'})}};const askAI=async()=>{const msg={role:'user',content:ask,ts:Date.now()};setChat(c=>[...c,msg]);setAsk('');try{const a=await api('POST','/api/ask',{q:msg.content,context:'memory'});setChat(c=>[...c,{role:'assistant',content:String(a?.answer||'(demo) ИИ: учту память, ответ сформирован.')}]);}catch{setChat(c=>[...c,{role:'assistant',content:'(demo) ИИ недоступна, ответ оффлайн.'}]);}};return(<div className='grid gap-4'><Card title='Поиск токена'><div className='flex gap-2 items-center'><Input placeholder='Название или контракт' value={q} onChange={e=>setQ((e.target as HTMLInputElement).value)}/><Button onClick={run}>Проверить</Button>{r&&<Button variant='ghost' onClick={()=>download(`report_${r.contract||'token'}.docx`,JSON.stringify(r,null,2),'application/vnd.openxmlformats-officedocument.wordprocessingml.document')}>DOCX</Button>}</div></Card>{r&&(<Card title={`Отчёт по ${r.name||'Token'}`}><div className='grid md:grid-cols-3 gap-3 text-sm'><div className='rounded-2xl border border-slate-800 p-3 flex items-center gap-2'><div><div className='text-slate-400'>Контракт</div><div className='text-slate-100'>{r.contract}</div></div><CopyBtn text={r.contract}/></div><div className='rounded-2xl border border-slate-800 p-3'><div className='text-slate-400'>Ликвидность</div><div className='text-slate-100'>{r.liq}</div></div><div className='rounded-2xl border border-slate-800 p-3'><div className='text-slate-400'>MCAP</div><div className='text-slate-100'>{r.mcap}</div></div><div className='rounded-2xl border border-slate-800 p-3'><div className='text-slate-400'>Риск</div><div className='text-slate-100'>{r.risk}</div></div><div className='rounded-2xl border border-slate-800 p-3'><div className='text-slate-400'>Безопасность</div><div className='text-slate-100'>GoPlus: {r.security?.goplus} • RugCheck: {r.security?.rug} • SolSniffer: {r.security?.sniffer}</div></div><div className='rounded-2xl border border-slate-800 p-3'><div className='text-slate-400'>Соцсети</div><div className='text-slate-100'>X: {r.social?.x} • TG: {r.social?.tg}</div></div></div><div className='mt-2 text-slate-100 font-semibold'>Вердикт ИИ: {r.verdict}</div><div className='mt-2 flex gap-2'><Button onClick={()=>openChart({mint:r.mint,links:r.links})}>График</Button><Button variant='ghost' onClick={()=>api('POST','/api/bot/buy',{mint:r.mint,amountSol:0.5}).catch(()=>{})}>Купить</Button></div></Card>)}<Card title='Чат с ИИ (память)'><div className='grid gap-2'><div className='max-h-52 overflow-auto rounded-xl border border-slate-800 bg-slate-900/50 p-2 text-sm'>{chat.map((m,i)=>(<div key={i} className='my-1'><Badge color={m.role==='user'?'yellow':'green'}>{m.role}</Badge> <span className='text-slate-200'>{m.content}</span></div>))}</div><div className='flex gap-2'><Input placeholder='Спросить у ИИ...' value={ask} onChange={e=>setAsk((e.target as HTMLInputElement).value)}/><Button onClick={askAI}>Спросить</Button></div></div></Card></div>)}